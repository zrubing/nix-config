#!/bin/bash

window_ids=()
window_titles=()
window_types=()

PORT=9222
DEBUG_URL="http://localhost:$PORT/json"

# æ£€æŸ¥æµè§ˆå™¨è¿œç¨‹è°ƒè¯•æ˜¯å¦å¯ç”¨
browser_tabs_available=false
if curl -s "$DEBUG_URL" > /dev/null 2>&1; then
    browser_tabs_available=true
fi

# è·å–æ™®é€šçª—å£
while read -r line; do
    id=$(echo "$line" | jq -r '.id')
    app_id=$(echo "$line" | jq -r '.app_id')
    title=$(echo "$line" | jq -r '.title')
    
    if [ -n "$id" ] && [ -n "$app_id" ]; then
        if [ "$app_id" == "brave-browser" ] && [ "$browser_tabs_available" = true ]; then
            # å¦‚æœæ˜¯æµè§ˆå™¨ä¸”æœ‰è°ƒè¯•ç«¯å£ï¼Œæ·»åŠ ä¸€ä¸ªæµè§ˆå™¨æ€»è§ˆé€‰é¡¹
            window_ids+=("browser:$id")
            window_titles+=("ğŸ“± Brave - æ‰€æœ‰æ ‡ç­¾é¡µ...")
            window_types+=("browser")
        else
            window_ids+=("window:$id")
            if [ -n "$title" ] && [ "$title" != "null" ] && [ "$title" != "" ]; then
                full_title="$app_id - $title"
                if [ ${#full_title} -gt 80 ]; then
                    display_title="${full_title:0:77}..."
                else
                    display_title="$full_title"
                fi
                window_titles+=("$display_title")
            else
                window_titles+=("$app_id")
            fi
            window_types+=("window")
        fi
    fi
done < <(niri msg --json windows | jq -c '.[]')

# æ·»åŠ æµè§ˆå™¨æ ‡ç­¾é¡µé€‰é¡¹
if [ "$browser_tabs_available" = true ]; then
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            id=$(echo "$line" | jq -r '.id // empty')
            title=$(echo "$line" | jq -r '.title // empty')
            url=$(echo "$line" | jq -r '.url // empty')
            
            if [ -n "$id" ] && [ -n "$title" ] && [ "$id" != "null" ] && [ "$title" != "null" ]; then
                window_ids+=("tab:$id")
                # ç®€åŒ–æ ‡é¢˜å’ŒURLæ˜¾ç¤º
                domain=$(echo "$url" | sed -e 's|^https\?://||' -e 's|^www\.||' -e 's|/.*||' | sed 's/[^a-zA-Z0-9.-]//g')
                full_title="ğŸŒ $title - $domain"
                if [ ${#full_title} -gt 80 ]; then
                    display_title="${full_title:0:77}..."
                else
                    display_title="$full_title"
                fi
                window_titles+=("$display_title")
                window_types+=("tab")
            fi
        fi
    done < <(curl -s "$DEBUG_URL" | jq -c '.[] | select(.type=="page")')
fi

# å¦‚æœæ²¡æœ‰æ‰¾åˆ°çª—å£ï¼Œé€€å‡º
if [ ${#window_ids[@]} -eq 0 ]; then
    echo "No windows found"
    exit 1
fi

# æ˜¾ç¤ºèœå•è®©ç”¨æˆ·é€‰æ‹©
result=$(printf "%s\n" "${window_titles[@]}" | fuzzel --dmenu --index --width=80 --lines=12 --match-mode=fuzzy)

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†é€‰é¡¹
if [ -n "$result" ] && [ "$result" != "-1" ]; then
    selected="${window_ids[$result]}"
    IFS=':' read -r type id <<< "$selected"
    
    case "$type" in
        "window")
            niri msg action focus-window --id "$id"
            ;;
        "browser")
            # èšç„¦æµè§ˆå™¨çª—å£
            niri msg action focus-window --id "$id"
            ;;
        "tab")
            # æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            activate_url="http://localhost:$PORT/json/activate/$id"
            curl -s "$activate_url" > /dev/null
            
            # èšç„¦æµè§ˆå™¨çª—å£ï¼ˆè·å–ç¬¬ä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼‰
            browser_info=$(niri msg --json windows)
            browser_window_id=$(echo "$browser_info" | jq -r '.[] | select(.app_id=="brave-browser") | .id' | head -1)
            if [ -n "$browser_window_id" ] && [ "$browser_window_id" != "null" ] && [ "$browser_window_id" != "" ]; then
                niri msg action focus-window --id "$browser_window_id"
            fi
            ;;
    esac
fi
