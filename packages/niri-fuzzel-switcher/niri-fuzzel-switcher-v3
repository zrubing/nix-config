#!/bin/bash

set -euo pipefail

PORT=9222
DEBUG_URL="http://localhost:$PORT/json"

window_ids=()
window_titles=()
window_types=()

# æ£€æŸ¥æµè§ˆå™¨è¿œç¨‹è°ƒè¯•æ˜¯å¦å¯ç”¨
browser_tabs_available=false
if curl -s --connect-timeout 2 "$DEBUG_URL" > /dev/null 2>&1; then
    browser_tabs_available=true
    echo "âœ… Brave è¿œç¨‹è°ƒè¯•ç«¯å£å¯ç”¨"
else
    echo "âŒ Brave è¿œç¨‹è°ƒè¯•ç«¯å£ä¸å¯ç”¨"
fi

# è·å–æ™®é€šçª—å£
if window_info=$(niri msg --json windows 2>/dev/null); then
    while read -r line; do
        if [ -n "$line" ]; then
            id=$(echo "$line" 2>/dev/null | jq -r '.id // empty' 2>/dev/null || echo "")
            app_id=$(echo "$line" 2>/dev/null | jq -r '.app_id // empty' 2>/dev/null || echo "")
            title=$(echo "$line" 2>/dev/null | jq -r '.title // empty' 2>/dev/null || echo "")
            
            if [ -n "$id" ] && [ -n "$app_id" ] && [ "$id" != "null" ] && [ "$app_id" != "null" ]; then
                if [ "$app_id" == "brave-browser" ] && [ "$browser_tabs_available" = true ]; then
                    # å¦‚æœæ˜¯æµè§ˆå™¨ä¸”æœ‰è°ƒè¯•ç«¯å£ï¼Œæ·»åŠ ä¸€ä¸ªæµè§ˆå™¨æ€»è§ˆé€‰é¡¹
                    window_ids+=("browser:$id")
                    window_titles+=("ğŸ“± Brave - æ‰€æœ‰æ ‡ç­¾é¡µ...")
                    window_types+=("browser")
                else
                    window_ids+=("window:$id")
                    if [ -n "$title" ] && [ "$title" != "null" ] && [ "$title" != "" ]; then
                        full_title="$app_id - $title"
                        if [ ${#full_title} -gt 80 ]; then
                            display_title="${full_title:0:77}..."
                        else
                            display_title="$full_title"
                        fi
                        window_titles+=("$display_title")
                    else
                        window_titles+=("$app_id")
                    fi
                    window_types+=("window")
                fi
            fi
        fi
    done < <(echo "$window_info" | jq -c '.[]' 2>/dev/null || echo "")
else
    echo "âŒ æ— æ³•è·å–çª—å£ä¿¡æ¯"
    exit 1
fi

# æ·»åŠ æµè§ˆå™¨æ ‡ç­¾é¡µé€‰é¡¹
if [ "$browser_tabs_available" = true ]; then
    echo "æ­£åœ¨è·å– Brave æ ‡ç­¾é¡µ..."
    if temp_data=$(curl -s --connect-timeout 3 --max-time 5 "$DEBUG_URL"); then
        if echo "$temp_data" | jq empty 2>/dev/null; then
            while IFS= read -r line; do
                if [ -n "$line" ]; then
                    id=$(echo "$line" 2>/dev/null | jq -r '.id // empty' 2>/dev/null || echo "")
                    title=$(echo "$line" 2>/dev/null | jq -r '.title // empty' 2>/dev/null || echo "")
                    url=$(echo "$line" 2>/dev/null | jq -r '.url // empty' 2>/dev/null || echo "")
                    
                    if [ -n "$id" ] && [ -n "$title" ] && [ "$id" != "null" ] && [ "$title" != "null" ]; then
                        window_ids+=("tab:$id")
                        # ç®€åŒ–åŸŸåæ˜¾ç¤º
                        domain=$(echo "$url" | sed -e 's|^https\?://||' -e 's|^www\.||' -e 's|/.*||' | tr -cd 'a-zA-Z0-9.-' || echo "unknown")
                        full_title="ğŸŒ $title - $domain"
                        if [ ${#full_title} -gt 80 ]; then
                            display_title="${full_title:0:77}..."
                        else
                            display_title="$full_title"
                        fi
                        window_titles+=("$display_title")
                        window_types+=("tab")
                    fi
                fi
            done < <(echo "$temp_data" | jq -c '.[] | select(.type=="page")' 2>/dev/null || echo "")
        else
            echo "âš ï¸ Brave è¿”å›çš„æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡æ ‡ç­¾é¡µ"
        fi
    else
        echo "âš ï¸ æ— æ³•è¿æ¥åˆ° Braveï¼Œè·³è¿‡æ ‡ç­¾é¡µ"
    fi
fi

# å¦‚æœæ²¡æœ‰æ‰¾åˆ°çª—å£ï¼Œé€€å‡º
if [ ${#window_ids[@]} -eq 0 ]; then
    echo "âŒ æ²¡æœ‰æ‰¾åˆ°çª—å£"
    exit 1
fi

echo "æ‰¾åˆ° ${#window_ids[@]} ä¸ªé€‰é¡¹"

# æ˜¾ç¤ºèœå•è®©ç”¨æˆ·é€‰æ‹©
if ! result=$(printf "%s\n" "${window_titles[@]}" | fuzzel --dmenu --index --width=80 --lines=12 --match-mode=fuzzy); then
    echo "ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©"
    exit 0
fi

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†é€‰é¡¹
if [ -n "$result" ] && [ "$result" != "-1" ]; then
    selected="${window_ids[$result]}"
    IFS=':' read -r type id <<< "$selected"
    
    case "$type" in
        "window")
            echo "åˆ‡æ¢åˆ°çª—å£: ${window_titles[$result]}"
            niri msg action focus-window --id "$id"
            ;;
        "browser")
            echo "èšç„¦æµè§ˆå™¨çª—å£"
            niri msg action focus-window --id "$id"
            ;;
        "tab")
            echo "åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${window_titles[$result]}"
            # æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            activate_url="http://localhost:$PORT/json/activate/$id"
            if curl -s --connect-timeout 2 "$activate_url" > /dev/null; then
                # èšç„¦æµè§ˆå™¨çª—å£
                if browser_info=$(niri msg --json windows 2>/dev/null); then
                    browser_window_id=$(echo "$browser_info" | jq -r '.[] | select(.app_id=="brave-browser") | .id' | head -1 2>/dev/null || echo "")
                    if [ -n "$browser_window_id" ] && [ "$browser_window_id" != "null" ] && [ "$browser_window_id" != "" ]; then
                        niri msg action focus-window --id "$browser_window_id"
                        echo "âœ… æ ‡ç­¾é¡µåˆ‡æ¢æˆåŠŸ"
                    else
                        echo "âš ï¸ æ ‡ç­¾é¡µå·²æ¿€æ´»ï¼Œä½†æ— æ³•èšç„¦æµè§ˆå™¨çª—å£"
                    fi
                else
                    echo "âš ï¸ æ ‡ç­¾é¡µå·²æ¿€æ´»ï¼Œä½†æ— æ³•è·å–çª—å£ä¿¡æ¯"
                fi
            else
                echo "âŒ æ— æ³•æ¿€æ´»æ ‡ç­¾é¡µ"
            fi
            ;;
    esac
else
    echo "æœªé€‰æ‹©çª—å£"
fi
